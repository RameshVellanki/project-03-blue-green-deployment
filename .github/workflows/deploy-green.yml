name: Deploy Green Environment

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Custom image name (leave empty to use latest from family)'
        required: false
        type: string

env:
  TERRAFORM_VERSION: '1.6.0'
  GCP_REGION: 'us-central1'
  GCP_ZONE: 'us-central1-a'

jobs:
  deploy-green:
    name: Deploy Green Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Get or Verify Image
        id: image
        env:
          INPUT_IMAGE: ${{ github.event.inputs.image_name }}
        run: |
          if [ -n "$INPUT_IMAGE" ]; then
            IMAGE_NAME="$INPUT_IMAGE"
            echo "Using provided image: $IMAGE_NAME"
          else
            IMAGE_NAME=$(gcloud compute images list \
              --filter="family:webapp" \
              --format="value(name)" \
              --sort-by="~creationTimestamp" \
              --limit=1)
            echo "Using latest image from family: $IMAGE_NAME"
          fi
          
          if [ -z "$IMAGE_NAME" ]; then
            echo "❌ No image found. Run build-image workflow first."
            exit 1
          fi
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          
          gcloud compute images describe "$IMAGE_NAME" \
            --format="table(name,family,status)"

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Deploy Green Environment
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
          TF_VAR_green_image: ${{ steps.image.outputs.image_name }}
          TF_VAR_active_environment: ${{ github.event.inputs.traffic_switch || 'blue' }}
        run: |
          echo "Deploying green environment..."
          terraform apply -auto-approve \
            -target=google_service_account.green_sa \
            -target=google_project_iam_member.green_logging \
            -target=google_project_iam_member.green_monitoring \
            -target=google_compute_health_check.http_health_check \
            -target=google_compute_instance_template.green \
            -target=google_compute_instance_group_manager.green \
            -target=google_compute_autoscaler.green

      - name: Get Deployment Info
        working-directory: ./terraform
        id: outputs
        run: |
          echo "lb_ip=$(terraform output -raw lb_ip_address)" >> $GITHUB_OUTPUT
          echo "active=$(terraform output -raw active_environment)" >> $GITHUB_OUTPUT

      - name: Wait for Green Instances
        run: |
          echo "Waiting for green instances to be ready..."
          sleep 90

      - name: Verify Green Environment
        env:
          LB_IP: ${{ steps.outputs.outputs.lb_ip }}
          ACTIVE: ${{ steps.outputs.outputs.active }}
        run: |
          echo "Load Balancer IP: $LB_IP"
          echo "Active Environment: $ACTIVE"
          
          if [ "$ACTIVE" != "green" ]; then
            echo "⚠️  Traffic not yet switched to green"
            echo "Green environment deployed but not receiving production traffic"
          fi
          
          echo "Testing green environment health..."
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "http://$LB_IP/health" || echo "000")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "✅ Green environment is healthy!"
              RESPONSE=$(curl -s "http://$LB_IP/health")
              echo "$RESPONSE" | jq .
              
              # Check which environment is responding
              ENV=$(echo "$RESPONSE" | jq -r '.environment' || echo "unknown")
              echo "Responding environment: $ENV"
              break
            fi
            
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: HTTP $HTTP_STATUS"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 15
          done

      - name: Deployment Summary
        if: always()
        env:
          IMAGE_NAME: ${{ steps.image.outputs.image_name }}
          LB_IP: ${{ steps.outputs.outputs.lb_ip }}
          ACTIVE: ${{ steps.outputs.outputs.active }}
        run: |
          echo "=========================================="
          echo "Green Environment Deployment Summary"
          echo "=========================================="
          echo "Image: $IMAGE_NAME"
          echo "Load Balancer IP: $LB_IP"
          echo "Active Environment: $ACTIVE"
          echo ""
          echo "MIG Status:"
          gcloud compute instance-groups managed describe green-mig \
            --zone=${{ env.GCP_ZONE }} \
            --format="value(status.isStable,targetSize,currentActions)" || echo "Green MIG not found"
          echo ""
          if [ "$ACTIVE" != "green" ]; then
            echo "⚠️  Green deployed but not active"
            echo "Run 'switch-traffic' workflow to switch to green"
          else
            echo "✅ Green environment is active and serving traffic"
          fi

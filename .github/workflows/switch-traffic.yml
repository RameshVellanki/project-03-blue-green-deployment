name: Switch Traffic

on:
  workflow_dispatch:
    inputs:
      target_environment:
        description: 'Target environment to switch traffic to'
        required: true
        type: choice
        options:
          - blue
          - green

env:
  TERRAFORM_VERSION: '1.6.0'
  GCP_REGION: 'us-central1'
  GCP_ZONE: 'us-central1-a'

jobs:
  switch-traffic:
    name: Switch Traffic
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Get Current State
        working-directory: ./terraform
        id: current
        run: |
          CURRENT_ENV=$(terraform output -raw active_environment 2>/dev/null || echo "none")
          LB_IP=$(terraform output -raw lb_ip_address 2>/dev/null || echo "none")
          
          echo "current_environment=$CURRENT_ENV" >> $GITHUB_OUTPUT
          echo "lb_ip=$LB_IP" >> $GITHUB_OUTPUT
          
          echo "Current active environment: $CURRENT_ENV"
          echo "Load Balancer IP: $LB_IP"

      - name: Verify Target Environment
        env:
          TARGET: ${{ github.event.inputs.target_environment }}
        run: |
          echo "Verifying $TARGET environment is healthy..."
          
          MIG_NAME="${TARGET}-mig"
          
          # Check MIG exists and has instances
          INSTANCE_COUNT=$(gcloud compute instance-groups managed list-instances "$MIG_NAME" \
            --zone=${{ env.GCP_ZONE }} \
            --format="value(name)" 2>/dev/null | wc -l)
          
          if [ "$INSTANCE_COUNT" -eq 0 ]; then
            echo "❌ $TARGET environment has no instances"
            echo "Deploy $TARGET environment first using deploy-$TARGET workflow"
            exit 1
          fi
          
          echo "✅ $TARGET environment has $INSTANCE_COUNT instances"
          
          # Check backend health
          BACKEND_NAME="${TARGET}-backend"
          HEALTHY_COUNT=$(gcloud compute backend-services get-health "$BACKEND_NAME" \
            --global \
            --format="value(status.healthStatus[].healthState)" 2>/dev/null | grep -c "HEALTHY" || echo "0")
          
          if [ "$HEALTHY_COUNT" -eq 0 ]; then
            echo "⚠️  Warning: No healthy instances in $TARGET backend"
            echo "Proceeding anyway, but traffic may fail"
          else
            echo "✅ $TARGET backend has $HEALTHY_COUNT healthy instances"
          fi

      - name: Switch Traffic
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
          TF_VAR_active_environment: ${{ github.event.inputs.target_environment }}
        run: |
          echo "Switching traffic to ${{ github.event.inputs.target_environment }}..."
          
          terraform apply -auto-approve \
            -target=google_compute_backend_service.app \
            -target=google_compute_url_map.app

      - name: Verify Traffic Switch
        env:
          LB_IP: ${{ steps.current.outputs.lb_ip }}
          TARGET: ${{ github.event.inputs.target_environment }}
        run: |
          echo "Waiting for traffic switch to propagate..."
          sleep 30
          
          echo "Verifying traffic is routing to $TARGET..."
          
          SUCCESS_COUNT=0
          TOTAL_TESTS=10
          
          for i in $(seq 1 $TOTAL_TESTS); do
            RESPONSE=$(curl -s "http://$LB_IP/health" || echo '{}')
            ENV=$(echo "$RESPONSE" | jq -r '.environment' 2>/dev/null || echo "unknown")
            
            echo "Test $i: Environment = $ENV"
            
            if [ "$ENV" = "$TARGET" ]; then
              SUCCESS_COUNT=$((SUCCESS_COUNT + 1))
            fi
            
            sleep 2
          done
          
          echo ""
          echo "Traffic routing results: $SUCCESS_COUNT/$TOTAL_TESTS requests to $TARGET"
          
          if [ "$SUCCESS_COUNT" -ge 8 ]; then
            echo "✅ Traffic successfully switched to $TARGET"
          else
            echo "⚠️  Traffic switch may be incomplete ($SUCCESS_COUNT/$TOTAL_TESTS)"
            echo "This may be due to load balancer propagation delay"
          fi

      - name: Monitor Old Environment
        env:
          CURRENT: ${{ steps.current.outputs.current_environment }}
          TARGET: ${{ github.event.inputs.target_environment }}
        run: |
          if [ "$CURRENT" != "none" ] && [ "$CURRENT" != "$TARGET" ]; then
            echo "Previous environment ($CURRENT) is now inactive"
            echo ""
            echo "Options:"
            echo "1. Keep $CURRENT for rollback capability"
            echo "2. Scale down $CURRENT to save costs:"
            echo "   gcloud compute instance-groups managed resize ${CURRENT}-mig --size=0 --zone=${{ env.GCP_ZONE }}"
            echo "3. Delete $CURRENT to fully clean up:"
            echo "   Run destroy workflow with target environment"
          fi

      - name: Traffic Switch Summary
        if: always()
        env:
          CURRENT: ${{ steps.current.outputs.current_environment }}
          TARGET: ${{ github.event.inputs.target_environment }}
          LB_IP: ${{ steps.current.outputs.lb_ip }}
        run: |
          echo "=========================================="
          echo "Traffic Switch Summary"
          echo "=========================================="
          echo "Previous Environment: $CURRENT"
          echo "New Environment: $TARGET"
          echo "Load Balancer IP: $LB_IP"
          echo ""
          echo "Access application:"
          echo "  http://$LB_IP"
          echo ""
          echo "Verify deployment:"
          echo "  curl http://$LB_IP/health | jq ."
          echo ""
          echo "Quick rollback (if needed):"
          echo "  Re-run this workflow and select '$CURRENT'"

name: Deploy Blue Environment

on:
  workflow_dispatch:
    inputs:
      image_name:
        description: 'Custom image name (leave empty to use latest from family)'
        required: false
        type: string

env:
  TERRAFORM_VERSION: '1.6.0'
  GCP_REGION: 'us-central1'
  GCP_ZONE: 'us-central1-a'

jobs:
  deploy-blue:
    name: Deploy Blue Environment
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Get or Verify Image
        id: image
        env:
          INPUT_IMAGE: ${{ github.event.inputs.image_name }}
        run: |
          if [ -n "$INPUT_IMAGE" ]; then
            IMAGE_NAME="$INPUT_IMAGE"
            echo "Using provided image: $IMAGE_NAME"
          else
            IMAGE_NAME=$(gcloud compute images list \
              --filter="family:webapp" \
              --format="value(name)" \
              --sort-by="~creationTimestamp" \
              --limit=1)
            echo "Using latest image from family: $IMAGE_NAME"
          fi
          
          if [ -z "$IMAGE_NAME" ]; then
            echo "‚ùå No image found. Run build-image workflow first."
            exit 1
          fi
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          
          gcloud compute images describe "$IMAGE_NAME" \
            --format="table(name,family,status)"

      - name: Terraform Init
        working-directory: ./terraform
        run: terraform init

      - name: Deploy Blue and Green Service Accounts
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
        run: |
          echo "Step 1: Creating service accounts and IAM bindings..."
          terraform apply -auto-approve \
            -var="blue_image=${{ steps.image.outputs.image_name }}" \
            -var="active_environment=blue" \
            -target=google_service_account.blue_sa \
            -target=google_project_iam_member.blue_logging \
            -target=google_project_iam_member.blue_monitoring \
            -target=google_service_account.green_sa \
            -target=google_project_iam_member.green_logging \
            -target=google_project_iam_member.green_monitoring

      - name: Deploy Health Check and Firewalls
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
        run: |
          echo "Step 2: Creating health check and firewall rules..."
          terraform apply -auto-approve \
            -var="blue_image=${{ steps.image.outputs.image_name }}" \
            -var="active_environment=blue" \
            -target=google_compute_health_check.http_health_check \
            -target=google_compute_firewall.allow_health_check \
            -target=google_compute_firewall.allow_lb_to_backends \
            -target=google_compute_firewall.allow_http_from_internet

      - name: Deploy Blue and Green MIGs
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
        run: |
          echo "Step 3: Creating blue MIG (active) and green MIG (standby with 0 instances)..."
          terraform apply -auto-approve \
            -var="blue_image=${{ steps.image.outputs.image_name }}" \
            -var="active_environment=blue" \
            -var="green_instance_count=0" \
            -target=google_compute_instance_template.blue \
            -target=google_compute_instance_group_manager.blue \
            -target=google_compute_autoscaler.blue \
            -target=google_compute_instance_template.green \
            -target=google_compute_instance_group_manager.green \
            -target=google_compute_autoscaler.green

      - name: Deploy Load Balancer
        working-directory: ./terraform
        env:
          TF_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          TF_VAR_region: ${{ env.GCP_REGION }}
          TF_VAR_zone: ${{ env.GCP_ZONE }}
        run: |
          echo "Step 4: Creating load balancer components..."
          terraform apply -auto-approve \
            -var="blue_image=${{ steps.image.outputs.image_name }}" \
            -var="active_environment=blue" \
            -var="green_instance_count=0"

      - name: Get Deployment Info
        working-directory: ./terraform
        id: outputs
        run: |
          echo "lb_ip=$(terraform output -raw lb_ip_address)" >> $GITHUB_OUTPUT
          echo "active=$(terraform output -raw active_environment)" >> $GITHUB_OUTPUT
          terraform output deployment_summary

      - name: Wait for Blue Instances
        run: |
          echo "Waiting for blue instances to be ready..."
          sleep 90

      - name: Verify Blue Environment
        env:
          LB_IP: ${{ steps.outputs.outputs.lb_ip }}
          ACTIVE: ${{ steps.outputs.outputs.active }}
        run: |
          echo "Load Balancer IP: $LB_IP"
          echo "Active Environment: $ACTIVE"
          
          echo "Testing blue environment via load balancer..."
          MAX_RETRIES=20
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            HTTP_STATUS=$(curl -s -o /dev/null -w "%{http_code}" --max-time 5 "http://$LB_IP/api/health" || echo "000")
            
            if [ "$HTTP_STATUS" -eq 200 ]; then
              echo "‚úÖ Blue environment is healthy and accessible via load balancer!"
              RESPONSE=$(curl -s "http://$LB_IP/api/health")
              echo "$RESPONSE" | jq .
              
              # Check which environment is responding
              ENV=$(echo "$RESPONSE" | jq -r '.environment' || echo "unknown")
              echo "Responding environment: $ENV"
              
              if [ "$ENV" == "blue" ]; then
                echo "‚úÖ Confirmed: Blue environment is serving traffic"
              else
                echo "‚ö†Ô∏è  Warning: $ENV environment is responding (expected blue)"
              fi
              break
            fi
            
            echo "Attempt $((RETRY_COUNT + 1))/$MAX_RETRIES: HTTP $HTTP_STATUS"
            RETRY_COUNT=$((RETRY_COUNT + 1))
            sleep 15
          done
          
          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "‚ö†Ô∏è  Health check did not return 200 within timeout"
            echo "This may be normal if instances are still starting up"
          fi

      - name: Deployment Summary
        if: always()
        env:
          IMAGE_NAME: ${{ steps.image.outputs.image_name }}
          LB_IP: ${{ steps.outputs.outputs.lb_ip }}
          ACTIVE: ${{ steps.outputs.outputs.active }}
        run: |
          echo "=========================================="
          echo "Blue-Green Deployment Summary"
          echo "=========================================="
          echo "Blue Image: $IMAGE_NAME"
          echo "Load Balancer IP: http://$LB_IP"
          echo "Active Environment: $ACTIVE"
          echo ""
          echo "Blue MIG Status:"
          gcloud compute instance-groups managed describe blue-mig \
            --zone=${{ env.GCP_ZONE }} \
            --format="value(status.isStable,targetSize,currentActions)" || echo "Blue MIG not found"
          echo ""
          echo "Green MIG Status:"
          gcloud compute instance-groups managed describe green-mig \
            --zone=${{ env.GCP_ZONE }} \
            --format="value(status.isStable,targetSize,currentActions)" || echo "Green MIG not found"
          echo ""
          echo "‚úÖ Blue environment deployed and serving traffic"
          echo "üìù Green MIG created with 0 instances (standby)"
          echo ""
          echo "Next steps:"
          echo "1. Test: curl http://$LB_IP/api/health"
          echo "2. Build new image for green deployment"
          echo "3. Run 'deploy-green' workflow to deploy new version"
          echo "4. Run 'switch-traffic' workflow to switch to green"

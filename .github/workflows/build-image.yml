name: Build Image

on:
  workflow_dispatch:

env:
  PACKER_VERSION: '1.10.0'
  GCP_ZONE: 'us-central1-a'

jobs:
  build:
    name: Build with Packer
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ secrets.GCP_PROJECT_ID }}

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Packer Init
        working-directory: ./packer
        run: packer init image.pkr.hcl

      - name: Packer Validate
        working-directory: ./packer
        env:
          PKR_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          PKR_VAR_zone: ${{ env.GCP_ZONE }}
        run: packer validate image.pkr.hcl

      - name: Build Image
        working-directory: ./packer
        env:
          PKR_VAR_project_id: ${{ secrets.GCP_PROJECT_ID }}
          PKR_VAR_zone: ${{ env.GCP_ZONE }}
          PKR_VAR_image_version: 1.0.0
        run: packer build image.pkr.hcl

      - name: Get Image Name
        id: image
        run: |
          if [ -f "packer/packer-manifest.json" ]; then
            IMAGE_NAME=$(jq -r '.builds[-1].artifact_id' packer/packer-manifest.json | cut -d: -f2)
            echo "Extracted image from manifest: $IMAGE_NAME"
          else
            # Fallback: try to get latest image from the webapp family
            IMAGE_NAME=$(gcloud compute images list \
              --filter="family:webapp" \
              --format="value(name)" \
              --sort-by="~creationTimestamp" \
              --limit=1)
            echo "Retrieved latest image from GCP: $IMAGE_NAME"
          fi
          
          if [ -z "$IMAGE_NAME" ]; then
            echo "❌ Failed to extract image name"
            exit 1
          fi
          
          echo "image_name=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "✅ Built: $IMAGE_NAME"

      - name: Summary
        env:
          IMAGE: ${{ steps.image.outputs.image_name }}
        run: |
          echo "======================================"
          echo "✅ Image Built Successfully"
          echo "======================================"
          echo "Image: $IMAGE"
          echo ""
          echo "Next: Run deploy workflow"

      - name: Build Summary
        if: always()
        env:
          IMAGE_NAME: ${{ steps.image.outputs.image_name }}
        run: |
          echo "=========================================="
          echo "Packer Build Summary"
          echo "=========================================="
          echo "Image Name: $IMAGE_NAME"
          echo "Image Family: webapp"
          echo "Project: ${{ secrets.GCP_PROJECT_ID }}"
          echo ""
          echo "Use this image for deployment:"
          echo "  $IMAGE_NAME"
